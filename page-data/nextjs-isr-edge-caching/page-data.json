{"componentChunkName":"component---src-templates-post-template-tsx","path":"/nextjs-isr-edge-caching/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<h1>📌 Next.js + Vercel에서 ISR 업데이트 지연 문제 해결기</h1>\n<p>최근에 <strong>모바일 청첩장</strong>을 Vercel에 배포하는 프로젝트를 진행했습니다. 디자인이 자주 바뀌고, 업데이트된 내용이 즉시 반영되어야 하는 환경에서 **ISR(Incremental Static Regeneration)**를 선택했는데, 예상 외의 문제가 있었습니다.</p>\n<h2>⚙️ 프로젝트 구성</h2>\n<ul>\n<li><strong>프레임워크</strong>: Next.js 14</li>\n<li><strong>배포 플랫폼</strong>: Vercel</li>\n<li><strong>렌더링 전략</strong>: <code class=\"language-text\">getStaticProps + revalidate</code></li>\n<li><strong>주요 페이지</strong>: <code class=\"language-text\">/invitation/[id]</code>, <code class=\"language-text\">/event/[slug]</code> 등 동적 경로 다수</li>\n<li><strong>요구사항</strong>: 페이지 데이터 업데이트 시, 최소한 수 분 이내로 반영 필요</li>\n</ul>\n<h2>❗️문제 상황: ISR 반영 지연</h2>\n<p>초기에는 <code class=\"language-text\">getStaticProps</code>에 <code class=\"language-text\">revalidate: 60</code>을 설정해, 최대 1분 주기로 콘텐츠를 갱신하도록 했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getStaticProps</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetchData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> data <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    revalidate<span class=\"token operator\">:</span> <span class=\"token number\">60</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>그런데 문제는 <strong>배포 직후, 또는 데이터가 변경된 직후에도 반영이 수 분 이상 지연</strong>된다는 것이었습니다. 특히 모바일에서 캐시된 페이지가 유지되어 <strong>이전 정보가 계속 노출되는 현상</strong>이 발생했습니다.</p>\n<h2>🔍 원인 분석</h2>\n<ol>\n<li><strong>ISR은 백그라운드에서 regenerate</strong> 하므로 첫 번째 사용자는 여전히 구버전을 볼 수 있음</li>\n<li><strong>Vercel CDN 캐시</strong>가 Edge에서 유지되며, 실제 regenerate된 버전이 반영되지 않음</li>\n<li>특히 <strong>동적 경로</strong>에서는 캐시 무효화 타이밍이 예측하기 어려움</li>\n</ol>\n<h2>💡 해결 방안: Edge Middleware + Cache-Control</h2>\n<h3>✅ 방법 1. <code class=\"language-text\">Cache-Control</code> 직접 제어</h3>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getServerSideProps</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> res <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">setHeader</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string\">'Cache-Control'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'public, max-age=0, s-maxage=60, stale-while-revalidate=30'</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetchData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> data <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>문제는 <strong>ISR이 아닌 SSR</strong>을 사용하는 방식이 되어, <strong>정적 페이지의 장점을 잃는다는 점</strong>이었습니다.</p>\n<hr>\n<h3>✅ 방법 2. Edge Middleware에서 캐시 우회</h3>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// middleware.ts</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> NextResponse <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'next/server'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">middleware</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> NextResponse<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 특정 경로에 대해 캐시 무효화 헤더 적용</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>nextUrl<span class=\"token punctuation\">.</span>pathname<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/invitation'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    res<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Cache-Control'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'no-cache, no-store'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이를 통해 <strong>CDN의 캐시를 강제로 무효화하거나, 경로 단위로 더 정밀하게 캐시 정책을 설정</strong>할 수 있었습니다.</p>\n<hr>\n<h2>⚖️ 적용 후 변화와 느낀 점</h2>\n<table>\n<thead>\n<tr>\n<th>항목</th>\n<th>개선 전</th>\n<th>개선 후</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>데이터 변경 반영 속도</td>\n<td>최대 수 분</td>\n<td>수 초 ~ 1분 이내</td>\n</tr>\n<tr>\n<td>모바일 캐시 문제</td>\n<td>자주 발생</td>\n<td>거의 없음</td>\n</tr>\n<tr>\n<td>초기 페이지 로딩 속도</td>\n<td>빠름</td>\n<td>약간 느림 (SSR fallback 시)</td>\n</tr>\n</tbody>\n</table>\n<h3>👍 장점</h3>\n<ul>\n<li>캐시 정책을 <strong>세분화하여 예측 가능한 상태로 제어</strong> 가능</li>\n<li>Edge Function을 이용하면 <strong>사용자 위치 기반 대응이나 조건부 캐싱</strong>도 가능</li>\n</ul>\n<h3>👎 단점</h3>\n<ul>\n<li>구성 복잡도 상승</li>\n<li>ISR의 정적 퍼포먼스를 부분 포기하는 구조</li>\n<li>Edge 함수 호출은 <strong>요금제와 호출 수</strong>에 민감</li>\n</ul>\n<hr>\n<h2>🧩 결론</h2>\n<blockquote>\n<p>Next.js의 ISR은 분명 강력하지만, <strong>즉시성 또는 실시간 반영이 중요한 서비스</strong>에는 단독으로 쓰기엔 부족한 점이 있습니다.</p>\n</blockquote>\n<p>실시간 반영이 필요한 경우엔 <code class=\"language-text\">ISR + Edge Function</code>, 또는 <code class=\"language-text\">SSR + 캐시 정책 조절</code>이 현실적인 선택이었습니다.</p>\n<blockquote>\n<p><strong>정적 빌드의 퍼포먼스를 원하면서도, 실시간성도 잡고 싶다면 “캐시 전략”이 핵심</strong>입니다.</p>\n</blockquote>\n<hr>\n<h2>📎 참고 자료</h2>\n<ul>\n<li><a href=\"https://nextjs.org/docs/pages/building-your-application/data-fetching/incremental-static-regeneration\" target=\"_blank\" rel=\"nofollow\">Next.js ISR 공식 문서</a></li>\n<li><a href=\"https://vercel.com/docs/middleware\" target=\"_blank\" rel=\"nofollow\">Vercel Edge Middleware 문서</a></li>\n</ul>","frontmatter":{"title":"Next.js + Vercel에서 ISR 업데이트 지연 문제 해결기","summary":"ISR의 캐싱 구조와 업데이트 반영 딜레이 문제, 그리고 Edge 함수와 캐싱 전략으로 개선한 과정","date":"2025.06.24.","categories":["Next.js","Vercel"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEIElEQVR42mVT61MTVxTP/9DPrZ2p35xaO6Mz9lMd6wfqVMV2itNaK6ClU20FjFYQDEUoLQEfw2CFNCwGgZDwVnkkJoRHks1myW4I7Hs3yYYQaIVRSDQQktzeqFg6nblz595z7u+ec37ndxQSD14tkQMBEch+IHGZq3/L/soVlNJhOeXn09I2u+KNW/anY2uJ57H1xfCmwKYENrnlSocCwO0Kl5ao4Zv/g9MCC5YiCRx3kwS59uy5xRLWG3zhYAbJM8mlMCi8oFIoFPd15sUwePNvBuwXMtlCa3QtvplIRlcBQ23SVALaRS4VlgHuihw4kLVr157Tp3+EpQXFrcjwBUcnHw2JDscTlo5Lwgun428vserGVkQ2yTOJqamI1Sr7yKiPjBHTqzNkzOlY5pgkBCqCEvB5X1xR9RSVdCjLjFVqa+3t8Z5+7gelvqubMfYJWh2pLO9XlvX+dnPsTrPjYmnn7zdNDJUICC8j80xqhlyz25etFhl3cCQmPRxEbWZcZhdWQsvi3IIHFe02iiJkh33JOraIoSsit63moJgO+cF68BHw16SkOiCrJwZqBnSVjepy2vYrmK9LBW4AsTruH4AsytJ/2YZgaIqL7UAqSYkVIKQaQC7db1SqK5VzpivwmhJU0BUX2wJCOiBuA8N+EJ5V1PmUwCKU2zOD4nOYR5zxcYSXwfEQzdDTXsbjhS4Sj+B4FNIGk33NNktvahBU0+JsbLZrEELTOl17y9ZppPVGukptMfbydzTuoZH5u1r3HxqHthVFdG4YHIZ8mTaXZuc2RC7JURsSlxC5Tdghnk5w9AY9G4dN4pn1cCA9NxNjqfV2PUl6YgFhmzznAyDkz3AGK4cLHjIWKbNDOub9QN9NFZUPXasZaeuyNbXYpvE1+EwBZbwgg44u7/eXe5W/PC5WjSgrTBeujpwvGSq6ZiqtGvUSUZja+ZIHRRX23KIHlgl60jmLuZ5CUSp4NgWl26Sd2v9Z/fHverLzDVnf6M5c6lNeHzl+puOjI/Umc/CvMKiuH8u/+PBscc+kk5m081BXsGyFANUbBCaTsP9w1RcFxqO57TkF9/KL28+VGs6VGt8/WNlp8MHfWXodCs7Q4+vt9w4PiwKbGS8FJA0mgGPLHx+tPpbXcfiU7lieVlU3+lN537eFHXuzausarLBykQcYKjknuklsyDk56EKXMjVDMKSOpeKf594+mNN0JLft0Im72XnNOQXIJ1827Pu0tvCqIboMnkQAMS1hdj1FDISEURe6CGfrtUjg6eTZ+rd2Zr+75+Q7u7/a8cGpHR/mvrc3/+3dX+87VFh2Xf+zSl9Zg9jMbcLsYEQcHh8P/RvZjT0zdPv+RKa0rVAG9pZ7TkTnatGhSJtLgzhuNVpvNDzWIPbRUcZq4c1mBs5vUAT/AH2ikZfXjQ1mAAAAAElFTkSuQmCC"},"images":{"fallback":{"src":"/static/5b455004afb365cd4e498c7e7489e58e/34104/Next2.png","srcSet":"/static/5b455004afb365cd4e498c7e7489e58e/5ce94/Next2.png 256w,\n/static/5b455004afb365cd4e498c7e7489e58e/8a20a/Next2.png 512w,\n/static/5b455004afb365cd4e498c7e7489e58e/34104/Next2.png 1024w","sizes":"(min-width: 1024px) 1024px, 100vw"},"sources":[{"srcSet":"/static/5b455004afb365cd4e498c7e7489e58e/99d55/Next2.webp 256w,\n/static/5b455004afb365cd4e498c7e7489e58e/3591c/Next2.webp 512w,\n/static/5b455004afb365cd4e498c7e7489e58e/e306d/Next2.webp 1024w","type":"image/webp","sizes":"(min-width: 1024px) 1024px, 100vw"}]},"width":1024,"height":1024}},"publicURL":"/static/5b455004afb365cd4e498c7e7489e58e/Next2.png"}}}}]}},"pageContext":{"slug":"/nextjs-isr-edge-caching/"}},"staticQueryHashes":[],"slicesMap":{}}